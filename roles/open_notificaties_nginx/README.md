Open Notificaties NGINX template and configuration
==================================================

Configure a reverse proxy for Open Notificaties with nginx.

This role includes the tasks, (default) variables and template for a working and secure
Open Notificaties deployment using nginx. Combine it with the role `nginxinc.nginx` to actually
install the virtual host.

Requirements
------------

- Depends on either the `open_notificaties_docker` or `open_notificaties_podman` role to provision a
  volume
- `openssl` to generate `dhparams` _if desired_
- optional: SSL certificates generated by Let's Encrypted or a traditional certificate
  provider

If you're on a SELinux enabled system, make sure that nginx can connect to the network:

```bash
setsebool httpd_can_network_connect on -P
```

Role variables
--------------

### SSL related

```yaml
opennotificaties_ssl: yes
opennotificaties_nginx_proto_value: '$scheme'
```

`opennotificaties_ssl` indicates whether Open Notificaties is supposedly accessed over HTTPS (only).
Publicly accessible Open Notificaties installations may not be exposed over plain HTTP.

`opennotificaties_nginx_proto_value` by default looks at the connection scheme of the client.
However, in configurations where SSL termination is performed _before_ nginx (because of
multiple reverse proxies, for example), you should set this to `'"https"'` otherwise
Open Notificaties is incorrectly told it's accessed over `http` rather than `https`.

`opennotificaties_nginx_location_prefix` is the location prefix to use. If this nginx instance
is behind another load balancer and the subpath is not stripped off, you should set this.
Defaults to the value of `opennotificaties_subpath` if set, otherwise `/`.

`opennotificaties_generate_dhparam: no`: in the past, it was required to generate stronger
DH-parameters, but on modern versions of NGINX and OS'es, this is not needed anymore.
If set to `true`, the parameters will be generated and included in the NGINX config.

`opennotificaties_ssl_protocols: 'TLSv1.2 TLSv1.3'`: SSL Labs testing decreased the rating from
A+ to B in January 2020 for servers supporting TLS 1.0 or 1.1

`opennotificaties_ssl_prefer_server_ciphers: 'off'`: in the past `on` was preferred, modern
configurations can leave this off.

`opennotificaties_ssl_ciphers: 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;'`

opennotificaties_ssl_hsts: 'max-age=63072000'

#### TLS certificates

When `opennotificaties_ssl` is `true`, the paths to the TLS key and certificate chain must be
provided. You can use your own certificates, or make use of Let's Encrypt to obtain
SSL certificates.

**Let's Encrypt**

The `opennotificaties_letsencrypt_enabled` variable is available. When enabled, the key and
certificate will be sourced from `/etc/letsencrypt/live/{{ opennotificaties_domain }}`.

The variable is `true` by default if the variable `certbot_certs` is defined (from the
`geerlingguy.certbot` role). If you're not using this role, you can specify it
explicitly:

```yaml
opennotificaties_letsencrypt_enabled: yes
```

**Own certificates**

You must explicitly specify the paths:

```yaml
opennotificaties_nginx_ssl_certificate: /path/to/ssl-cert-chain.pem
opennotificaties_nginx_ssl_key: /path/to/ssl-key.pem
```

Note that the certificate chain must include the certificate + all intermediate
certificates. The first certificate must correspond with the private key.

### Security headers

`opennotificaties_csp: ''`: define the Content Security Policy, for example:

```
opennotificaties_csp: "frame-ancestors 'self' https://*.haarlem.nl;          report-uri https://haarlem.report-uri.com/r/d/csp/enforce"
```

See https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP for more information.

Dependencies
------------

None.

Example Playbook
----------------

```yaml
- hosts: app-servers
  roles:
    - role: geerlingguy.postgresql
      tags:
        - db

    - role: geerlingguy.certbot

    - role: app_database
      vars:
        app_db_provision_user: no
        app_db_provision_database: no
        app_db_become_user: postgres

        app_db_host: ''
        app_db_port: "{{ opennotificaties_db_port }}"
        app_db_name: "{{ opennotificaties_db_name }}"
        app_db_extensions:
          - pg_trgm
      tags:
        - app_db

    - role: open_notificaties_docker
      vars:
        opennotificaties_version: 'latest'  # see https://hub.docker.com/r/openzaak/open-notificaties/tags
      tags:
        - replicas

    - role: nginxinc.nginx
      vars:
        nginx_http_template:
          default:
            # set by open_notificaties_docker role
            template_file: "{{ opennotificaties_nginx_template }}"
            conf_file_name: opennotificaties.conf
            conf_file_location: /etc/nginx/conf.d/
      tags:
        - replicas
```

License
-------

EUPL-1.2
