---

- name: Create pod for containers
  containers.podman.podman_pod:
    name: openzaak
    state: created
    ports: "{{ lookup('template', 'pod_ports.yml.j2') | from_yaml }}"
  become: yes
  become_user: "{{ openzaak_podman_user }}"

- name: Run the cache service
  containers.podman.podman_container:
    name: openzaak-cache
    pod: openzaak
    image: docker.io/library/redis:5
    restart_policy: always
  become: yes
  become_user: "{{ openzaak_podman_user }}"

- name: Run the Open Zaak backend service
  containers.podman.podman_container:
    name: "{{ item.name }}"
    pod: openzaak
    image: "{{ openzaak_image }}"
    restart_policy: always
    state: started
    restart: "{{ openzaak_env_file_template.changed }}"
    volumes:
      - /var/run/postgresql:/var/run/postgresql
      - openzaak-private-media:/app/private-media
    env_file: "{{ openzaak_env_file }}"
    env:
      UWSGI_PORT: "{{ item.port }}"
      DB_HOST: "{{ openzaak_db_host }}"
      DB_PORT: "{{ openzaak_db_port | string }}"
      SECRET_KEY: "{{ openzaak_secret_key }}"
      SUBPATH: "{{ openzaak_subpath }}"
  with_items: "{{ openzaak_replicas }}"
  become: yes
  become_user: "{{ openzaak_podman_user }}"
